<!DOCTYPE html>
<html lang="en">
<!-- 
TODO:
Fix re-sizing after moving map
Adding and removing icons
Re-design intro tutorial -->


<head>
    <title>Cartography Project</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='js/tutorial.js'></script>
    <script src='js/store.js'></script>
    <script src='js/buffers.js'></script>
    <script src='js/voronoi.js'></script>
    <script src='geo/to_cts.js'></script>
    <script src='js/huff.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
        integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
        crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <style>

    </style>

</head>


<body style="overflow:hidden;">
    <div class="mobileShow">
        TEXT OR IMAGE FOR MOBILE HERE
    </div>
    <nav id="top-nav" class="navbar navbar-expand-lg navbar-light mobileHide" style="display:none;">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
            aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="container-fluid">
            <ul class="navbar-nav nav-tabs col-10">
                <a class="navbar-brand" href="#">Spatial Models</a>
                <li class="nav-item top-nav-link">
                    <a id="buffer-link" class="nav-link top-nav-link active" href="#buffer">Buffer</a>
                </li>
                <li class="nav-item top-nav-link">
                    <a id="voronoi-link" class="nav-link" href="#voronoi">Voronoi</a>
                </li>
                <li class="nav-item top-nav-link">
                    <a id="huff-link" class="nav-link" href="#huff">Huff</a>
                </li>

            </ul>
            <ul class="nav navbar-nav nav-tabs navbar-right col-2">
                <li class="nav-item top-nav-link mr-sm-2">
                    <a id="tut-link" class="nav-link" href="#tutorial">Tutorial</a>
                </li>
                <li class="nav-item mr-sm-2">
                    <a class="nav-link" href="http://jackforsyth.com" target="_blank">About</a>
                </li>
            </ul>
        </div>

    </nav>

    <div class="container-fluid h-100" class="mobileHide">
        <div id='map-row' class="row justify-content-end">
            <nav id="model-control-bar" class="nav flex-column" style="display:none;">


                <div id="buffer-panel" class="card model-control-panel col-md-12">

                    <ul class="list-group list-group-flush text-center">
                        <li class="list-group-item" style="padding-right:10px;">

                            <div class="card-body">
                                <h5 class="font-weight-bold mb-3">Buffers</h5>
                                <p class="mb-0">Buffers calculate a specified distance from a store to the area that
                                    surrounds it.</p>
                            </div>
                        </li>
                        <li class="list-group-item" style="padding-right:10px;">

                            </label>
                            <div id="buffer-type-buttons" class="btn-group btn-group-toggle">
                                <label id="euclidean-buff-button" class="btn btn-secondary active">
                                    <input type="radio" name="options" id="euclidean-buff-radio" autocomplete="off"
                                        value="euc" checked>Euclidean
                                </label>
                                <label id="drivetime-buff-button" class="btn btn-secondary">
                                    <input type="radio" name="options" id="drivetime-buff-radio" autocomplete="off"
                                        value="drivetime">Drive time
                                </label>
                            </div>
                            <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                data-placement="top" style="left:5px;"><span class="tooltiptext">Tooltip text</span></i>
                        </li>

                        <li class="list-group-item">
                            <div class="row d-flex justify-content-center">
                                <div id="buffer-distance-buttons" class="btn-group btn-group-toggle">
                                    <label id="buffer-distance-variable-radio" class="btn btn-secondary active">
                                        <input type="radio" name="options" id="variable-buff-radio" autocomplete="off"
                                            value="variable" checked>Variable
                                        distance
                                    </label>
                                    <label id="buffer-distance-fixed-radio" class="btn btn-secondary">
                                        <input type="radio" name="options" id="fixed-buff-radio" autocomplete="off"
                                            value="fixed">Fixed
                                        distance
                                    </label></div>
                                <div class="row d-flex justify-content-center my-4">
                                    <input type="range" class="custom-range" id="buffer-distance-range" min="1" max="5"
                                        defaultValue="3" autocomplete="off">

                                </div>
                                <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                    data-placement="top"
                                    style="margin-right:2px;margin-left:0px;left:30px;float:right;z-index:999;"><span
                                        class="tooltiptext">Tooltip text</span></i>
                            </div>

                        </li>

                        <li class="list-group-item"><button type="button" class="btn btn-primary add-btn">Add
                                store</button>
                            <span></span>
                            <button type="button" class="btn btn-warning rem-btn">Remove store</button>
                        </li>
                    </ul>
                    <div class="card-body text-center" style="font-size: 12px;">
                        <b>Buffers in depth:</b> A buffer around a store creates an area of a specified distance away
                        from a store. Distance can be calculated
                        using different methods, such as straight-line (Euclidean) distance, or a distance measured in
                        travel time. They are relatively simple to communicate,
                        but can create difficulties when there are overlaps, because they are a deterministic model -
                        customers can only shop at one store. Buffer analysis can be made more powerful by incorporating
                        customer
                        demographic variables like income, education level, and age, so that stores can be sure to
                        locate near their target customers. A buffer's size can be based on a retail analyst's gut
                        feeling,
                        customer surveys, or other quantiative methods.<br>
                        <a href="https://docs.qgis.org/3.10/en/docs/gentle_gis_introduction/vector_spatial_analysis_buffers.html?highlight=buffer%20spatial%20analysis"
                            class="card-link" target="_blank">Learn more about buffers</a>
                        <p></p>
                    </div>
                </div>

                <div id="voronoi-panel" class="card model-control-panel collapse col-md-12" style="display:none;">
                    <ul class="list-group list-group-flush text-center">

                        <li class="list-group-item text-center">
                            <div class="card-body">
                                <h5 class="font-weight-bold mb-3">Voronoi polygons</h5>
                                <p class="mb-0">Voronoi polygons create trade areas where every real world location is
                                    attributed to the store that it is closest to.</p>
                            </div>

                        </li>
                        <li class="list-group-item" style="padding-right:10px;">
                            <button type="button" class="btn btn-primary add-btn">Add store</button>
                            <span></span>
                            <button type="button" class="btn btn-warning rem-btn">Remove
                                store</button></li>
                        <li class="list-group-item" style="padding-right:10px;">
                            <div class="card-body text-center" style="font-size: 12px;">
                                <b>Voronoi polygons in depth: </b>This will soon go in more depth about polygons.
                                <a href="https://www.gislounge.com/voronoi-diagrams-and-gis/" class="card-link"
                                    target="_blank">Learn more about voronoi polygons</a>

                            </div>
                        </li>
                    </ul>
                </div>

                <div>
                    <div id="huff-panel" class="card model-control-panel collapse col-md-12" style="display:none;">

                        <ul class="list-group list-group-flush text-center">
                            <li class="list-group-item text-center">

                                <div class="card-body">
                                    <h5 class="font-weight-bold mb-3">Huff model</h5>
                                    <p class="mb-0">The Huff model calculates the likelihood of an individual using a
                                        store based on the store's square footage and their distance from the store.</p>
                                </div>

                            </li>
                            <li class="list-group-item ">
                                <div>Attractiveness exponent: <span id="huff-att-label"><b>2</b></span></div>
                                <div class="d-flex row"> <input type="range" class="custom-range col-md-8 mx-auto"
                                        id="huff-att-exponent" min="1" max="3" defaultValue="2" autocomplete="off"
                                        step="0.2">
                                    <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                        data-placement="top"
                                        style="margin-right:2px;margin-left:0px;left:-8%;float:right;z-index:999;"><span
                                            class="tooltiptext">Tooltip text</span></i></div>


                                <div style="margin-top:10px;">Distance decay exponent: <span
                                        id="huff-dist-label"><b>2</b></span></div>
                                <div class="d-flex row" style="margin-bottom:10px;"> <input type="range"
                                        class="custom-range col-md-8 mx-auto" id="huff-dist-exponent" min="1" max="3"
                                        defaultValue="2" autocomplete="off" step="0.2">
                                    <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                        data-placement="top"
                                        style="margin-right:2px;margin-left:0px;left:-8%;float:right;z-index:999;"><span
                                            class="tooltiptext">Tooltip text</span></i></div>

                            </li>
                            <li class="list-group-item"><button type="button" class="btn btn-primary add-btn">Add
                                    store</button>
                                <span></span>
                                <button type="button" class="btn btn-warning rem-btn">Remove store</button>
                            </li>
                        </ul>
                        <div class="card-body text-center" style="font-size: 12px;">
                            <b>Huff model in depth: </b>This will soon go in more depth about the Huff model.
                            <a href="https://gisgeography.com/huff-gravity-model/" class="card-link"
                                target="_blank">Learn more about voronoi polygons</a>

                        </div>
                    </div>
            </nav>
            <div class='col col-md-12' id='map'></div>
        </div>
        <div id="tutorial-row" class='row align-items-center' style="height:20vh;">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <p id="tutorial-text" class="tutorial-text justify-content-center align-items-center">These icons
                    represent
                    store locations.</span></p>
            </div>
            <div class="col-md-2 text-center">
                <button id="tutorial-next-button" class='btn btn-block btn-dark btn-lg pulse'
                    onclick="goToTutorialStage(currentTutorialStage + 1)">Next</button>
                <button class='tutorial-skip btn btn-block btn-outline-secondary btn-xs' onclick="endTutorial()">Skip
                    tutorial</button>
            </div>
        </div>

        <body>
    </div>
    <script>
        L.mapbox.accessToken = 'pk.eyJ1Ijoicmlrb3c5NSIsImEiOiJjajJtYnZhbmswMHV1MzN0ajM3NHNzOHh5In0.q6-T946dwyUkr1ml9-qRbw';

        var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/{z}/{x}/{y}?access_token=' + L.mapbox.accessToken, {
            attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            tileSize: 512,
            zoomOffset: -1
        });
        var southWest = L.latLng(42.697167, -81.75650);
        var northEast = L.latLng(45.350278, -77.001428);
        var map = L.map('map', { zoomControl: false, attributionControl: false, maxBounds: L.latLngBounds(southWest, northEast), }).setView([43.6914494, -79.4602967], 12);


        // Set starting stores
        addStore(43.6914494, -79.5446757)
        addStore(43.6914494, -79.3759177)

        // Cycle through the tutorial sequence on a schedule
        var example = ['car dealership', 'shoe store&nbsp;&nbsp;&nbsp;&nbsp;', 'grocery store&nbsp;&nbsp;'];

        map.on('mouseup', function (e) {
            map.removeEventListener('mousemove');
            map.invalidateSize()
        });

        textSequence(0);
        function textSequence(i) {

            if (example.length > i) {
                setTimeout(function () {
                    try {
                        document.getElementById("sequence").innerHTML = example[i];
                        textSequence(++i);
                    }
                    catch { }
                }, 5000);
            } else if (example.length == i) { // Loop
                textSequence(0);
            }

        }
        // Toggle map zoom on or off
        function toggleMapMovement(enable) {
            if (enable == false) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
                map.scrollWheelZoom.disable();
                map.boxZoom.disable();
                map.keyboard.disable();
                map.dragging.disable();
            }
            else {
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();
                map.boxZoom.enable();
                map.keyboard.enable();
                map.dragging.enable();
            }
        }



        var ct_layer = L.geoJSON(to_cts)

        // Set initial map state
        // TODO: make this a function?
        map.on('contextmenu', function (e) { });
        toggleMapMovement(false)
        function handleNav(e) {
            elem = e[0]
            if (elem.tagName == "LI") {
                elem = elem.firstElementChild
            }

            var tabs = ["voronoi-link", "buffer-link", "huff-link"]
            // if (tabs.indexOf(elem.id) < 0) {
            //     return false;
            // }

            for (tab of tabs) {
                $('#'.concat(tab)).removeClass("active")
            }

            $('.model-control-panel').hide("fast")
            if (elem.id == "voronoi-link") {
                $('#voronoi-panel').show()
                $('#voronoi-panel').toggleClass("active")
                $('#voronoi-link').toggleClass("active")
                clearVizLayers()
                voronoizeStores()
            }
            else if (elem.id == "buffer-link") {
                $('#buffer-panel').show("fast")
                $('#buffer-panel').toggleClass("active")
                $('#buffer-link').toggleClass("active")
                clearVizLayers()
                bufferAllStores()
            }
            else if (elem.id == "reilly-link") {
                $('#reilly-panel').show("fast")
                $('#reilly-panel').toggleClass("active")
                $('#reilly-link').toggleClass("active")
                clearVizLayers()
            }
            else if (elem.id == "huff-link") {
                $('#huff-panel').show("fast")
                $('#huff-panel').toggleClass("active")
                $('#huff-link').toggleClass("active")
                clearVizLayers()
                calcHuff()
            }
            else if (elem.id == "tut-link") {
                location.reload()
            }
        }
        $('.top-nav-link').click(function () {
            map.invalidateSize();
            handleNav($(this));
            map.invalidateSize();
            return false;
        });
        $("#buffer-distance-buttons label").click(function () {
            $(this).addClass('active').siblings().removeClass('active');
            updateActiveLayer()
        })
        $("#buffer-type-buttons label").click(function () {
            $(this).addClass('active').siblings().removeClass('active');
            console.log("Click2")
            updateActiveLayer()
        })

        $('.add-btn').on('click', function (e) {
            addStore()
            updateActiveLayer()
        })
        $('.rem-btn').on('click', function (e) {
            removeStore()
            updateActiveLayer()
        })
        $("#buffer-distance-range").on("input change", function (e) {
            bufferAllStores();
        });
        $("#huff-dist-exponent").on("input change", function (e) {
            calcHuff();
            val = e.currentTarget.valueAsNumber
            document.getElementById("huff-dist-label").innerHTML = `<b>${val}</b>`
        });
        $("#huff-att-exponent").on("input change", function (e) {
            calcHuff();
            val = e.currentTarget.valueAsNumber
            document.getElementById("huff-att-label").innerHTML = `<b>${val}</b>`
        });
        // For testing, bypass tutorial
        endTutorial()
        window.onresize = map.invalidateSize();

    </script>
</body>