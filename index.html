<!DOCTYPE html>
<html lang="en">
<!-- 
TODO:
Fix re-sizing after moving map
Adding and removing icons
Re-design intro tutorial -->


<head>
    <title>Cartography Project</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='js/tutorial.js'></script>
    <script src='js/store.js'></script>
    <script src='js/buffers.js'></script>
    <script src='js/voronoi.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
        integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
        crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <style>

    </style>

</head>


<body onresize="invalidateMapSize(1000)">
    <nav id="top-nav" class="navbar navbar-expand-lg navbar-light" style="display:none;">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
            aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <ul class="navbar-nav nav-tabs">
            <a class="navbar-brand" href="#">Spatial Models</a>
            <li class="nav-item top-nav-link">
                <a id="buffer-link" class="nav-link top-nav-link active" href="#buffer">Buffers</a>
            </li>
            <li class="nav-item top-nav-link">
                <a id="voronoi-link" class="nav-link" href="#voronoi">Voronoi</a>
            </li>
            <li class="nav-item top-nav-link">
                <a id="reilly-link" class="nav-link" href="#reilly">Reilly's</a>
            </li>
            <li class="nav-item top-nav-link">
                <a id="huff-link" class="nav-link" href="#huff">Huff</a>
            </li>
        </ul>

    </nav>
    <div class="container-fluid h-100">


        </nav>
        <div id='map-row' class="row justify-content-end">
            <nav id="model-control-bar" class="nav flex-column" style="display:none;">


                <div id="buffer-panel" class="card model-control-panel" style="width: 20rem;">
                    <div class="card-body">
                        <h5 class="font-weight-bold mb-3">Buffers</h5>
                        <p class="mb-0">Buffers calculate a consistent distance from a store to the area that surrounds
                            them.</p>
                    </div>
                    <ul class="list-group list-group-flush text-center">
                        <li class="list-group-item" style="padding-right:10px;">

                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-secondary active">
                                    <input type="radio" name="options" id="option1" autocomplete="off" checked>Euclidean
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="options" id="option2" autocomplete="off">Drive time
                                </label>



                            </div>
                            <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                data-placement="top" style="left:5px;"><span class="tooltiptext">Tooltip text</span></i>
                        </li>

                        <li class="list-group-item">
                            <div class="row d-flex justify-content-center">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label id="buffer-distance-fixed-radio" class="btn btn-secondary active">
                                        <input type="radio" name="options" id="option1" autocomplete="off" checked>Fixed
                                        distance
                                    </label>
                                    <label id="buffer-distance-variable-radio" class="btn btn-secondary">
                                        <input type="radio" name="options" id="option2" autocomplete="off">Variable
                                        distance
                                    </label></div>
                                <div class="row d-flex justify-content-center my-4">
                                    <input type="range" class="custom-range" id="buffer-distance-range" min="1" max="5"
                                        defaultValue="3" autocomplete="off">

                                </div>
                                <i class="far fa-question-circle 2x help-hover tooltip" data-toggle="tooltip"
                                    data-placement="top"
                                    style="margin-right:2px;margin-left:0px;left:30px;float:right;z-index:999;"><span
                                        class="tooltiptext">Tooltip text</span></i>
                            </div>

                        </li>
                        <li class="list-group-item">Vestibulum at eros</li>
                        <li class="list-group-item"><button type="button"
                                class="btn btn-primary add-btn">Add store</button>
                            <span></span>
                            <button type="button" class="btn btn-warning rem-btn">Remove
                                store</button></li>
                    </ul>
                    <div class="card-body">
                        <a href="#!" class="card-link">Card link</a>
                        <a href="#!" class="card-link">Another link</a>
                    </div>
                </div>
                <div>
                    <div id="voronoi-panel" class="card model-control-panel collapse"
                        style="width: 20rem; display:none;">
                        <div class="card-body">
                            <h5 class="font-weight-bold mb-3">Voronoi polygons</h5>
                            <p class="mb-0">Some quick example text to build on the panel title and make up the bulk
                                of
                                the panel's content.</p>
                        </div>
                        <li class="list-group-item"><button type="button"
                            class="btn btn-primary add-btn">Add store</button>
                        <span></span>
                        <button type="button" class="btn btn-warning rem-btn">Remove
                            store</button></li>
                        <div class="card-body">
                            <a href="#!" class="card-link">Card link</a>
                            <a href="#!" class="card-link">Another link</a>

                        </div>
                    </div>
                </div>
                <div>
                    <div id="reilly-panel" class="card model-control-panel collapse"
                        style="width: 20rem; display:none;">
                        <div class="card-body">
                            <h5 class="font-weight-bold mb-3">Reilly's Law</h5>
                            <p class="mb-0">Some quick example text to build on the panel title and make up the
                                bulk
                                of
                                the panel's content.</p>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Cras justo odio</li>
                            <li class="list-group-item">Dapibus ac facilisis in</li>
                            <li class="list-group-item">Vestibulum at eros</li>
                        </ul>
                        <div class="card-body">
                            <a href="#!" class="card-link">Card link</a>
                            <a href="#!" class="card-link">Another link</a>

                        </div>
                    </div>
                </div>
                <div>
                    <div id="huff-panel" class="card model-control-panel collapse" style="width: 20rem; display:none;">
                        <div class="card-body">
                            <h5 class="font-weight-bold mb-3">Huff model</h5>
                            <p class="mb-0">Some quick example text to build on the panel title and make
                                up the bulk
                                of
                                the panel's content.</p>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Cras justo odio</li>
                            <li class="list-group-item">Dapibus ac facilisis in</li>
                            <li class="list-group-item">Vestibulum at eros</li>
                        </ul>
                        <div class="card-body">
                            <a href="#!" class="card-link">Card link</a>
                            <a href="#!" class="card-link">Another link</a>

                        </div>
                    </div>
                </div>
            </nav>
            <div class='col col-md-12' id='map'></div>
        </div>
        <div id="tutorial-row" class='row align-items-center' style="height:20vh;">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <p id="tutorial-text" class="tutorial-text justify-content-center align-items-center">This icon
                    represents a&nbsp;<span id="sequence">grocery store</span></p>
            </div>
            <div class="col-md-2 text-center">
                <button id="tutorial-next-button" class='btn btn-block btn-dark btn-lg pulse'
                    onclick="goToTutorialStage(currentTutorialStage + 1)">Next</button>
                <button class='tutorial-skip btn btn-block btn-outline-secondary btn-xs' onclick="endTutorial()">Skip
                    tutorial</button>
            </div>
        </div>

        <body>
    </div>
    <script>
        L.mapbox.accessToken = 'pk.eyJ1Ijoicmlrb3c5NSIsImEiOiJjajJtYnZhbmswMHV1MzN0ajM3NHNzOHh5In0.q6-T946dwyUkr1ml9-qRbw';

        var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/{z}/{x}/{y}?access_token=' + L.mapbox.accessToken, {
            attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            tileSize: 512,
            zoomOffset: -1
        });
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([43.7138687, -79.7816961], 13);
        // map.setMaxBounds(map.getBounds());

        addStore()

        // Cycle through the tutorial sequence on a schedule
        var example = ['car dealership', 'shoe store&nbsp;&nbsp;&nbsp;&nbsp;', 'grocery store&nbsp;&nbsp;'];

        map.on('mouseup', function (e) {
            map.dragging.enable();
            map.removeEventListener('mousemove');
        });

        textSequence(0);
        function textSequence(i) {

            if (example.length > i) {
                setTimeout(function () {
                    try {
                        document.getElementById("sequence").innerHTML = example[i];
                        textSequence(++i);
                    }
                    catch { }
                }, 5000);
            } else if (example.length == i) { // Loop
                textSequence(0);
            }

        }
        // Toggle map zoom on or off
        function toggleMapMovement(enable) {
            if (enable == false) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
                map.scrollWheelZoom.disable();
                map.boxZoom.disable();
                map.keyboard.disable();
            }
            else {
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();
                map.boxZoom.enable();
                map.keyboard.enable();
            }
        }



        // Set initial map state
        // TODO: make this a function?
        map.on('contextmenu', function (e) { });
        toggleMapMovement(false)
        function handleNav(e) {
            elem = e[0]
            if (elem.tagName == "LI") {
                elem = elem.firstElementChild
            }

            var tabs = ["voronoi-link", "buffer-link", "reilly-link", "huff-link"]
            // if (tabs.indexOf(elem.id) < 0) {
            //     return false;
            // }

            for (tab of tabs) {
                $('#'.concat(tab)).removeClass("active")
            }

            $('.model-control-panel').hide("fast")
            if (elem.id == "voronoi-link") {
                $('#voronoi-panel').show("fast")
                $('#voronoi-panel').toggleClass("active")
                $('#voronoi-link').toggleClass("active")
                clearVizLayers()
                voronoizeStores()
            }
            else if (elem.id == "buffer-link") {
                $('#buffer-panel').show("fast")
                $('#buffer-panel').toggleClass("active")
                $('#buffer-link').toggleClass("active")
                clearVizLayers()
                bufferAllStores()
            }
            else if (elem.id == "reilly-link") {
                $('#reilly-panel').show("fast")
                $('#reilly-panel').toggleClass("active")
                $('#reilly-link').toggleClass("active")
                clearVizLayers()
            }
            else if (elem.id == "huff-link") {
                $('#huff-panel').show("fast")
                $('#huff-panel').toggleClass("active")
                $('#huff-link').toggleClass("active")
                clearVizLayers()
            }
        }
        $('.top-nav-link').click(function () {
            handleNav($(this)); return false;
        });

        $('#buffer-distance-variable-radio').on('click', function (e) {
            $('#buffer-distance-range').prop("disabled", false);
            bufferAllStores()
        })

        $('#buffer-distance-fixed-radio').on('click', function (e) {
            $('#buffer-distance-range').prop("disabled", false);
        })
        $('.add-btn').on('click', function (e) {
            addStore()
            updateActiveLayer()
        })
        $('.rem-btn').on('click', function (e) {
            removeStore()
            updateActiveLayer()
        })
        $("#buffer-distance-range").on("input change", function (e) {
            bufferAllStores();
        });
        // For testing, bypass tutorial
        endTutorial()


    </script>
</body>